<!DOCTYPE html><html><head><title>Binny: JDBC</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="eikek" /><meta name="description" content="Binny – Scala library for files in databases" /><meta name="og:image" content="/binny/img/poster.png" /><meta name="image" property="og:image" content="/binny/img/poster.png" /><meta name="og:title" content="Binny: JDBC" /><meta name="title" property="og:title" content="Binny: JDBC" /><meta name="og:site_name" content="Binny" /><meta name="og:url" content="https://github.com/eikek/binny" /><meta name="og:type" content="website" /><meta name="og:description" content="Binny – Scala library for files in databases" /><link rel="icon" type="image/png" href="/binny/img/favicon.png" /><meta name="twitter:title" content="Binny: JDBC" /><meta name="twitter:image" content="/binny/img/poster.png" /><meta name="twitter:description" content="Binny – Scala library for files in databases" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="35x35" href="/binny/img/favicon.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/binny/highlight/styles/vs.css" /><link rel="stylesheet" href="/binny/css/light-style.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/binny/" class="brand"><div class="brand-wrapper"></div><span>Binny</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/binny/index" title="Home" class="">Home</a></div> <div class="sidebar-nav-item  "><a href="/binny/core" title="Core Api" class="drop-nested">Core Api</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/binny/core/binarystore" title="BinaryStore" class="">BinaryStore</a> <a href="/binny/core/chunkedstore" title="ChunkedBinaryStore" class="">ChunkedBinaryStore</a> <a href="/binny/core/detect" title="ContentTypeDetect" class="">ContentTypeDetect</a></div></div> <div class="sidebar-nav-item  open"><a href="/binny/impls" title="Implementation Modules" class="drop-nested">Implementation Modules</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/binny/fs" title="Filesystem" class="">Filesystem</a> <a href="/binny/jdbc" title="JDBC" class="active">JDBC</a> <a href="/binny/pglo" title="PG LargeObject" class="">PG LargeObject</a> <a href="/binny/minio" title="MinIO" class="">MinIO</a></div></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="search-nav"><div id="search-dropdown"><label><i class="fa fa-search"></i>Search</label><input id="search-bar" type="text" placeholder="Enter keywords here..." onclick="displayToggleSearch(event)" /><ul id="search-dropdown-content" class="dropdown dropdown-content"></ul></div></li><li id="gh-eyes-item" class="hidden-xs to-uppercase"><a href="https://github.com/eikek/binny" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs to-uppercase"><a href="https://github.com/eikek/binny" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="eikek" data-github-repo="binny"><div class="content-wrapper"><section><h1 id="generic-jdbc">Generic JDBC</h1>

<p>This module provides a <code class="language-plaintext highlighter-rouge">BinaryStore</code> using JDBC. It is tested for H2,
PostgreSQL and MariaDB only, but other database systems probably work
as well. The module doesn’t include any JDBC driver, you need to pull
in the one you want to use in your project.</p>

<p>The approach is as follows: the byte stream is split in chunks (size
can be configured) and each chunk is stored in a blob column and
associated to the same binary id.</p>

<h2 id="table-structure">Table Structure</h2>

<p>Since the blob datatype characteristics differ between databases, you
might want to define the table yourself or use the provided setup for
PostgreSQL or MariaDB. See the <code class="language-plaintext highlighter-rouge">CreateDataTable</code> for the table
definitions. Here is the definition for PostgreSQL:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="nv">"file_chunk"</span> <span class="p">(</span>
  <span class="nv">"file_id"</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">254</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
  <span class="nv">"chunk_nr"</span> <span class="nb">int</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
  <span class="nv">"chunk_len"</span> <span class="nb">int</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
  <span class="nv">"chunk_data"</span> <span class="n">bytea</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
  <span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="nv">"file_id"</span><span class="p">,</span> <span class="nv">"chunk_nr"</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

<p>This makes range requests efficient, since it is possible to calculate
at what chunk to start (and to end if applicable).</p>

<p>The table names are just examples, they can be specified when creating
a store.</p>

<h2 id="chunksize-when-storing-and-streaming">Chunksize when storing and streaming</h2>

<p>A caveat here is that the chunksize used to store a file, also
determines the amount of memory used when reading the file. It is not
possible to store in 512k chunks and then load it in 10k chunks, for
example. The reason is that many jdbc drivers (at least these I know)
don’t support streaming from a blob. You’ll get the whole blob in a
byte array anyways. So this cannot be changed after a file has been
stored. When streaming, the blob of each row is loaded in memory, one
at a time. Its size defines the amount of memory used to stream a
file.</p>

<p>If you’re using PostgreSQL, consider the <a href="pglo">pglo</a> module which
doesn’t have this restriction.</p>

<h2 id="usage">Usage</h2>

<p>You need to provide a <code class="language-plaintext highlighter-rouge">javax.sql.DataSource</code>. How to create this is
out of scope for this project. A <code class="language-plaintext highlighter-rouge">JdbcStoreConfig</code> is required, that
defines some settings, like the table name and chunk size to use.</p>

<p>For the examples here, an in-memory database
(<a href="https://h2database.com">H2</a>) is used.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">binny._</span>
<span class="k">import</span> <span class="nn">binny.util.Logger</span>
<span class="k">import</span> <span class="nn">binny.jdbc._</span>
<span class="k">import</span> <span class="nn">binny.ExampleData._</span>
<span class="k">import</span> <span class="nn">cats.effect.IO</span>
<span class="k">import</span> <span class="nn">cats.effect.unsafe.implicits._</span>

<span class="k">val</span> <span class="nv">dataSource</span> <span class="k">=</span> <span class="nv">ConnectionConfig</span><span class="o">.</span><span class="py">h2Memory</span><span class="o">(</span><span class="s">"docs"</span><span class="o">).</span><span class="py">dataSource</span>
<span class="c1">// dataSource: javax.sql.DataSource = ds0: url=jdbc:h2:mem:docs;MODE=PostgreSQL;DATABASE_TO_LOWER=TRUE;DB_CLOSE_DELAY=-1 user=sa</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="nv">logger</span> <span class="k">=</span> <span class="nv">Logger</span><span class="o">.</span><span class="py">silent</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span>
<span class="c1">// logger: Logger[IO] = binny.util.Logger$$anon$2@214738c1</span>
<span class="k">val</span> <span class="nv">store</span> <span class="k">=</span> <span class="nv">GenericJdbcStore</span><span class="o">.</span><span class="py">default</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="n">dataSource</span><span class="o">,</span> <span class="nv">Logger</span><span class="o">.</span><span class="py">silent</span><span class="o">[</span><span class="kt">IO</span><span class="o">])</span>
<span class="c1">// store: GenericJdbcStore[IO] = binny.jdbc.GenericJdbcStore$Impl@623dc959</span>

<span class="c1">// creates the schema, the table name is same as in the default config</span>
<span class="nv">DatabaseSetup</span><span class="o">.</span><span class="py">runData</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="nv">Dbms</span><span class="o">.</span><span class="py">H2</span><span class="o">,</span> <span class="n">dataSource</span><span class="o">,</span> <span class="s">"file_chunk"</span><span class="o">).</span><span class="py">unsafeRunSync</span><span class="o">()</span>
<span class="c1">// res0: Int = 0</span>

<span class="k">val</span> <span class="nv">someData</span> <span class="k">=</span> <span class="nv">ExampleData</span><span class="o">.</span><span class="py">file2M</span>
<span class="c1">// someData: Binary[IO] = Stream(..)</span>
<span class="k">val</span> <span class="nv">id</span> <span class="k">=</span> <span class="nv">someData</span><span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">store</span><span class="o">.</span><span class="py">insert</span><span class="o">)</span>
  <span class="o">.</span><span class="py">compile</span><span class="o">.</span><span class="py">lastOrError</span><span class="o">.</span><span class="py">unsafeRunSync</span><span class="o">()</span>
<span class="c1">// id: BinaryId = BinaryId(8kAic6mb33RzWps9LAtHceyuhv74qmTonjdsVZEDpvK3)</span>

<span class="c1">// get the file out</span>
<span class="nv">store</span><span class="o">.</span><span class="py">findBinary</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="nv">ByteRange</span><span class="o">.</span><span class="py">All</span><span class="o">).</span><span class="py">getOrElse</span><span class="o">(</span><span class="nv">sys</span><span class="o">.</span><span class="py">error</span><span class="o">(</span><span class="s">"not found"</span><span class="o">))</span>
  <span class="o">.</span><span class="py">flatMap</span><span class="o">(</span><span class="n">binary</span> <span class="k">=&gt;</span> <span class="nv">binary</span><span class="o">.</span><span class="py">readUtf8String</span><span class="o">)</span>
  <span class="o">.</span><span class="py">unsafeRunSync</span><span class="o">()</span>
  <span class="o">.</span><span class="py">take</span><span class="o">(</span><span class="mi">50</span><span class="o">)</span>
<span class="c1">// res1: String = """hello world 1</span>
<span class="c1">// hello world 2</span>
<span class="c1">// hello world 3</span>
<span class="c1">// hello wo"""</span>
</code></pre></div></div>

<h2 id="jdbcbinarystore">JdbcBinaryStore</h2>

<p>As seen above, the store is an instance of the trait
<code class="language-plaintext highlighter-rouge">JdbcBinaryStore</code>. It extends <code class="language-plaintext highlighter-rouge">BinaryStore</code> to add a
<code class="language-plaintext highlighter-rouge">findBinaryStateful</code> method. The “state” relates to the connection to
the database.</p>

<p>The default <code class="language-plaintext highlighter-rouge">findBinary</code> method uses one connection per chunk. This
allows to free resources each time the stream is pulled. Otherwise
timeouts could occur, if for example the stream is not being pulled
for a while. When a network client is consuming the stream with a slow
connection, reading one chunk takes a while and could lead to the
connection being closed (by the pool or server).</p>

<p>However, if you know to process only small files or consume the data
fast, it is possible to stream the whole file using a single
connection, which is faster. This is provided by <code class="language-plaintext highlighter-rouge">findBinaryStateful</code>.</p>

<h2 id="chunkedbinarystore">ChunkedBinaryStore</h2>

<p>The <code class="language-plaintext highlighter-rouge">GenericJdbcStore</code> also implements <code class="language-plaintext highlighter-rouge">ChunkedBinaryStore</code> to allow
storing chunks independently. This is useful if chunks are received in
random order and the whole file is not available as complete stream.</p>

<p>However, in order to use this the complete size of the file must be
known up front. This is needed to know when the last chunk is
received.</p>
</section></div></div></div></div><script src="/binny/highlight/highlight.pack.js"></script><script src="/binny/lunr/lunr.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script src="/binny/js/fathom.js"></script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script src="/binny/js/search.js"></script><script src="/binny/js/docs.js"></script></body></html>